@page "/treatment-plans"
@page "/treatment-plans/{PatientId:int}"
@using CloudDentalOffice.Portal.Models
@inject ITreatmentPlanService TreatmentPlanService
@inject IPatientService PatientService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Treatment Plans - Cloud Dental Office</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4" Style="background: #0a0a0a; border: 1px solid #00ffff;">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Typo="Typo.h4" Style="color: #00ffff; font-weight: bold;">
                    <MudIcon Icon="@Icons.Material.Filled.Assignment" Class="mr-2" />
                    Treatment Plans
                </MudText>
                <MudText Typo="Typo.body2" Style="color: #b0b0b0;">
                    Create and manage patient treatment plans
                </MudText>
            </div>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddTreatmentPlanDialog"
                       StartIcon="@Icons.Material.Filled.Add">
                New Treatment Plan
            </MudButton>
        </MudStack>
    </MudPaper>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mt-4">
            <MudText Typo="Typo.body1" Style="font-family: monospace; white-space: pre-wrap;">@_errorMessage</MudText>
        </MudAlert>
    }

    <MudPaper Class="pa-4 mt-4" Style="background: #0a0a0a; border: 1px solid rgba(0, 255, 255, 0.3);">
        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else if (_selectedPatient == null)
        {
            <MudStack Spacing="3" AlignItems="AlignItems.Center" Class="py-8">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" Style="color: #00ffff;" />
                <MudText Typo="Typo.h6" Style="color: #b0b0b0;">
                    Select a patient to view treatment plans
                </MudText>
                <MudAutocomplete T="Patient" Value="_selectedPatient" Label="Search Patient"
                                 SearchFunc="@SearchPatients" ToStringFunc="@(p => p?.FullName ?? "")"
                                 Variant="Variant.Outlined" color="Color.Primary"
                                 AdornmentIcon="@Icons.Material.Filled.Search"
                                 ValueChanged="@OnPatientSelected" />
            </MudStack>
        }
        else
        {
            <MudTable Items="@_treatmentPlans" Hover="true" Striped="true" Dense="true">
                <ToolBarContent>
                    <MudText Typo="Typo.h6" Style="color: #00ffff;">
                        Treatment Plans for @_selectedPatient.FullName
                    </MudText>
                    <MudSpacer />
                    <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="ClearPatientSelection"
                               StartIcon="@Icons.Material.Filled.Clear">
                        Change Patient
                    </MudButton>
                    <MudChip T="string" Color="Color.Info" Size="Size.Small">Total: @_treatmentPlans.Count</MudChip>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh Style="color: #00ffff;">Title</MudTh>
                    <MudTh Style="color: #00ffff;">Provider</MudTh>
                    <MudTh Style="color: #00ffff;">Status</MudTh>
                    <MudTh Style="color: #00ffff;">Created Date</MudTh>
                    <MudTh Style="color: #00ffff;">Presented Date</MudTh>
                    <MudTh Style="color: #00ffff;">Accepted Date</MudTh>
                    <MudTh Style="color: #00ffff;">Procedures</MudTh>
                    <MudTh Style="color: #00ffff;">Est. Cost</MudTh>
                    <MudTh Style="color: #00ffff;">Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Title">
                        <MudText Typo="Typo.body2" Style="font-weight: bold;">
                            @(context.Title ?? "Untitled Plan")
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Provider">
                        <MudText Typo="Typo.body2">@context.Provider?.FullName</MudText>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        @{
                            var statusColor = context.Status switch
                            {
                                "Draft" => Color.Default,
                                "Proposed" => Color.Info,
                                "Accepted" => Color.Success,
                                "InProgress" => Color.Warning,
                                "Completed" => Color.Success,
                                "Cancelled" => Color.Error,
                                _ => Color.Default
                            };
                        }
                        <MudChip T="string" Color="statusColor" Size="Size.Small">@context.Status</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Created">
                        <MudText Typo="Typo.body2">@context.CreatedDate.ToString("MM/dd/yyyy")</MudText>
                    </MudTd>
                    <MudTd DataLabel="Presented">
                        <MudText Typo="Typo.body2">
                            @(context.PresentedDate?.ToString("MM/dd/yyyy") ?? "-")
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Accepted">
                        <MudText Typo="Typo.body2">
                            @(context.AcceptedDate?.ToString("MM/dd/yyyy") ?? "-")
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Procedures">
                        <MudText Typo="Typo.body2">@context.PlannedProcedures.Count</MudText>
                    </MudTd>
                    <MudTd DataLabel="Est. Cost">
                        <MudText Typo="Typo.body2" Style="color: #00ff88;">
                            @context.TotalEstimatedCost.ToString("C")
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Info"
                                       OnClick="@(() => ViewTreatmentPlan(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                       OnClick="@(() => EditTreatmentPlan(context))" />
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText Style="color: #b0b0b0;">No treatment plans found for this patient</MudText>
                </NoRecordsContent>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public int? PatientId { get; set; }
    
    private List<TreatmentPlan> _treatmentPlans = new();
    private List<Patient> _allPatients = new();
    private Patient? _selectedPatient = null;
    private bool _loading = false;
    private string? _errorMessage = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadPatients();
        
        // If PatientId is provided, load that patient
        if (PatientId.HasValue)
        {
            try
            {
                _selectedPatient = await PatientService.GetPatientByIdAsync(PatientId.Value.ToString());
                if (_selectedPatient != null)
                {
                    await LoadTreatmentPlans();
                }
            }
            catch (Exception ex)
            {
                _errorMessage = $"Error loading patient: {ex.Message}";
                Snackbar.Add(_errorMessage, Severity.Error);
            }
        }
    }

    private async Task LoadPatients()
    {
        try
        {
            _allPatients = await PatientService.GetPatientsAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading patients: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
    }

    private async Task<IEnumerable<Patient>> SearchPatients(string searchString, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return _allPatients.Take(10);

        return _allPatients
            .Where(p => p.FullName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            .Take(10);
    }

    private async Task OnPatientSelected(Patient? patient)
    {
        _selectedPatient = patient;
        if (patient != null)
        {
            await LoadTreatmentPlans();
        }
    }

    private async Task LoadTreatmentPlans()
    {
        if (_selectedPatient == null) return;

        try
        {
            _loading = true;
            _errorMessage = null;
            _treatmentPlans = await TreatmentPlanService.GetTreatmentPlansAsync(_selectedPatient!.PatientId.ToString());
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading treatment plans: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void ClearPatientSelection()
    {
        _selectedPatient = null;
        _treatmentPlans.Clear();
    }

    private async Task OpenAddTreatmentPlanDialog()
    {
        if (_selectedPatient == null)
        {
            Snackbar.Add("Please select a patient first", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters<AddEditTreatmentPlanDialog>
        {
            { x => x.PatientId, _selectedPatient!.PatientId },
            { x => x.PatientName, _selectedPatient!.FullName }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Large, 
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AddEditTreatmentPlanDialog>("New Treatment Plan", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadTreatmentPlans();
        }
    }

    private async Task ViewTreatmentPlan(TreatmentPlan plan)
    {
        var parameters = new DialogParameters<ViewTreatmentPlanDialog>
        {
            { x => x.TreatmentPlan, plan }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.ExtraLarge, 
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ViewTreatmentPlanDialog>("Treatment Plan Details", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is bool shouldRefresh && shouldRefresh)
        {
            await LoadTreatmentPlans();
        }
    }

    private async Task EditTreatmentPlan(TreatmentPlan plan)
    {
        var parameters = new DialogParameters<AddEditTreatmentPlanDialog>
        {
            { x => x.PatientId, plan.PatientId },
            { x => x.PatientName, _selectedPatient?.FullName ?? "" },
            { x => x.ExistingTreatmentPlan, plan }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Large, 
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AddEditTreatmentPlanDialog>("Edit Treatment Plan", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadTreatmentPlans();
        }
    }
}
