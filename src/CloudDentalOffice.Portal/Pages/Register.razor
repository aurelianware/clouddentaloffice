@page "/register"
@attribute [AllowAnonymous]
@using CloudDentalOffice.Portal.Services
@using CloudDentalOffice.Portal.Services.Auth
@inject IAuthService AuthService
@inject IStripeService StripeService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IConfiguration Configuration

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-12">
    <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-6">Register Your Practice</MudText>

        @if (azureAdEnabled)
        {
            <!-- Azure AD Sign-Up (Primary) -->
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large"
                      FullWidth="true" StartIcon="@Icons.Material.Filled.Business"
                      Href="/MicrosoftIdentity/Account/SignIn" Class="mb-6">
                Sign up with Microsoft Azure AD
            </MudButton>

            <MudDivider Class="mb-6">
                <MudText Typo="Typo.body2" Color="Color.Secondary">Or create local account</MudText>
            </MudDivider>
        }

        <MudForm @ref="form">
             <MudTextField T="string" Label="Practice Name" Required="true" RequiredError="Practice Name is required!"
                          @bind-Value="registerRequest.TenantName" Class="mb-4"/>

            <MudGrid>
                <MudItem xs="6">
                    <MudTextField T="string" Label="First Name" Required="true" RequiredError="First Name is required!"
                          @bind-Value="registerRequest.FirstName" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField T="string" Label="Last Name" Required="true" RequiredError="Last Name is required!"
                          @bind-Value="registerRequest.LastName" />
                </MudItem>
            </MudGrid>

            <MudTextField T="string" Label="Email" Required="true" RequiredError="Email is required!"
                          @bind-Value="registerRequest.Email" InputType="InputType.Email" Class="mt-4" />

            <MudTextField T="string" Label="Password" Required="true" RequiredError="Password is required!"
                          @bind-Value="registerRequest.Password" InputType="InputType.Password" Class="mt-4" />
                          
            <MudSelect T="string" Label="Plan" @bind-Value="registerRequest.PlanId" Class="mt-4" Disabled="isLoadingPlans">
                @if (isLoadingPlans)
                {
                    <MudSelectItem Value="@("")">Loading plans...</MudSelectItem>
                }
                else if (stripeProducts.Count == 0)
                {
                    <MudSelectItem Value="@("")">No plans available</MudSelectItem>
                }
                else
                {
                    @foreach (var product in stripeProducts)
                    {
                        var priceDisplay = product.UnitAmount > 0 
                            ? $"${(product.UnitAmount / 100m):F2}/mo" 
                            : "Custom";
                        <MudSelectItem Value="@product.PriceId">@product.Name (@priceDisplay)</MudSelectItem>
                    }
                }
            </MudSelect>

            <div class="d-flex flex-column align-center mt-6 gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="DoRegister" FullWidth="true">Register</MudButton>
                <MudLink Href="/login">Already have an account? Login</MudLink>
            </div>
            
            @if (!string.IsNullOrEmpty(error))
            {
                <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mt-4">@error</MudAlert>
            }
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    MudForm form = null!;
    RegistrationRequest registerRequest = new RegistrationRequest();
    string error = string.Empty;
    List<StripeProductInfo> stripeProducts = new();
    bool isLoadingPlans = true;
    bool azureAdEnabled;

    protected override async Task OnInitializedAsync()
    {
        azureAdEnabled = Configuration.GetValue("AzureAd:Enabled", false);
        
        try
        {
            // Load Stripe products
            stripeProducts = await StripeService.GetProductsAsync();
            
            // Set first product as default
            if (stripeProducts.Count > 0)
            {
                registerRequest.PlanId = stripeProducts[0].PriceId;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading plans: {ex}");
        }
        finally
        {
            isLoadingPlans = false;
        }
    }

    private async Task DoRegister()
    {
        error = string.Empty;
        try
        {
            await form.Validate();
            if(!form.IsValid) return;

            var success = await AuthService.RegisterAsync(registerRequest);
            if (success)
            {
                Snackbar.Add("Registration successful! Please login.", Severity.Success);
                Navigation.NavigateTo("/login");
            }
            else
            {
                error = "Registration failed. Email may already be in use.";
            }
        }
        catch (Exception ex)
        {
            error = "An error occurred during registration.";
            Console.WriteLine(ex);
        }
    }
}
