@page "/vision/devices"
@using CloudDentalOffice.Contracts.Vision
@inject IVisionService VisionService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Vision Devices — Cloud Dental Office</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">

    @* ── Header Bar ── *@
    <MudPaper Class="pa-4 mb-4" Style="background: linear-gradient(135deg, #1a2332 0%, #0d1b2a 100%); border-left: 4px solid #00ffff;">
        <MudGrid Justify="Justify.SpaceBetween">
            <MudItem>
                <MudText Typo="Typo.h5" Style="color: #e0e0e0;">
                    <MudIcon Icon="@Icons.Material.Filled.Devices" Class="mr-2" Style="color: #00ffff;" />
                    Vision Devices
                </MudText>
                <MudText Typo="Typo.body2" Style="color: #90a4ae;">
                    Manage privaseeAI cameras and edge devices
                </MudText>
            </MudItem>
            <MudItem>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="OpenRegisterDialog">
                    Register New Device
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @* ── Loading State ── *@
    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    @* ── Devices Table ── *@
    <MudPaper Elevation="2" Style="background-color: #1e2a3a; border: 1px solid #2d3e50;">
        <MudTable Items="_devices" Hover="true" Dense="true" Elevation="0"
                  Style="background-color: transparent;">
            <HeaderContent>
                <MudTh Style="color: #90a4ae;">
                    <MudTableSortLabel SortBy="new Func<VisionDeviceDto, object>(x => x.Status)">
                        Status
                    </MudTableSortLabel>
                </MudTh>
                <MudTh Style="color: #90a4ae;">
                    <MudTableSortLabel SortBy="new Func<VisionDeviceDto, object>(x => x.Name)">
                        Name
                    </MudTableSortLabel>
                </MudTh>
                <MudTh Style="color: #90a4ae;">Type</MudTh>
                <MudTh Style="color: #90a4ae;">Location</MudTh>
                <MudTh Style="color: #90a4ae;">IP Address</MudTh>
                <MudTh Style="color: #90a4ae;">Model</MudTh>
                <MudTh Style="color: #90a4ae;">Last Heartbeat</MudTh>
                <MudTh Style="color: #90a4ae;">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <MudChip T="string" Size="Size.Small" Color="GetStatusColor(context.Status)">
                        @context.Status
                    </MudChip>
                </MudTd>
                <MudTd Style="color: #e0e0e0;">
                    <div class="d-flex align-center">
                        <MudIcon Icon="@GetDeviceIcon(context.Type)" Size="Size.Small" Class="mr-2"
                                 Style="@($"color: {GetStatusIconColor(context.Status)}")" />
                        @context.Name
                    </div>
                </MudTd>
                <MudTd Style="color: #e0e0e0;">@context.Type</MudTd>
                <MudTd Style="color: #e0e0e0;">
                    <div>
                        <div>@context.Location</div>
                        @if (!string.IsNullOrEmpty(context.LocationName))
                        {
                            <MudText Typo="Typo.caption" Style="color: #90a4ae;">@context.LocationName</MudText>
                        }
                    </div>
                </MudTd>
                <MudTd Style="color: #e0e0e0;">
                    <MudText Typo="Typo.body2">@context.IpAddress</MudText>
                    @if (!string.IsNullOrEmpty(context.MacAddress))
                    {
                        <MudText Typo="Typo.caption" Style="color: #90a4ae;">@context.MacAddress</MudText>
                    }
                </MudTd>
                <MudTd Style="color: #e0e0e0;">
                    @if (!string.IsNullOrEmpty(context.ActiveModelName))
                    {
                        <div>
                            <div>@context.ActiveModelName</div>
                            <MudText Typo="Typo.caption" Style="color: #90a4ae;">v@context.ActiveModelVersion</MudText>
                        </div>
                    }
                    else
                    {
                        <span style="color: #90a4ae;">—</span>
                    }
                </MudTd>
                <MudTd Style="color: #e0e0e0;">
                    @if (context.LastHeartbeat.HasValue)
                    {
                        var timeSince = DateTime.UtcNow - context.LastHeartbeat.Value;
                        if (timeSince.TotalMinutes < 5)
                        {
                            <MudText Typo="Typo.body2" Style="color: #00ff88;">Just now</MudText>
                        }
                        else if (timeSince.TotalHours < 1)
                        {
                            <MudText Typo="Typo.body2">@((int)timeSince.TotalMinutes)m ago</MudText>
                        }
                        else if (timeSince.TotalDays < 1)
                        {
                            <MudText Typo="Typo.body2">@((int)timeSince.TotalHours)h ago</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Style="color: #ef5350;">@((int)timeSince.TotalDays)d ago</MudText>
                        }
                    }
                    else
                    {
                        <span style="color: #90a4ae;">Never</span>
                    }
                </MudTd>
                <MudTd>
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        <MudMenuItem Icon="@Icons.Material.Filled.Settings" OnClick="@(() => UpdateStatus(context, DeviceStatus.Maintenance))">
                            Set Maintenance
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.CheckCircle" OnClick="@(() => UpdateStatus(context, DeviceStatus.Online))">
                            Set Online
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Cancel" OnClick="@(() => UpdateStatus(context, DeviceStatus.Offline))">
                            Set Offline
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" OnClick="@(() => ViewDevice(context))">
                            View Details
                        </MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>

</MudContainer>

@code {
    private bool _loading = true;
    private List<VisionDeviceDto> _devices = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDevices();
    }

    private async Task LoadDevices()
    {
        _loading = true;
        try
        {
            _devices = await VisionService.GetDevicesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading devices: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenRegisterDialog()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        
        var dialog = await DialogService.ShowAsync<RegisterDeviceDialog>("Register New Device", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadDevices();
            Snackbar.Add("Device registered successfully!", Severity.Success);
        }
    }

    private async Task UpdateStatus(VisionDeviceDto device, DeviceStatus newStatus)
    {
        try
        {
            await VisionService.UpdateDeviceStatusAsync(device.Id, newStatus);
            Snackbar.Add($"Device status updated to {newStatus}", Severity.Success);
            await LoadDevices();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating device status: {ex.Message}", Severity.Error);
        }
    }

    private void ViewDevice(VisionDeviceDto device)
    {
        // Navigate to device detail page (to be created)
        Snackbar.Add("Device details view coming soon!", Severity.Info);
    }

    private Color GetStatusColor(DeviceStatus status) => status switch
    {
        DeviceStatus.Online => Color.Success,
        DeviceStatus.Offline => Color.Default,
        DeviceStatus.Error => Color.Error,
        DeviceStatus.Maintenance => Color.Warning,
        DeviceStatus.Provisioning => Color.Info,
        _ => Color.Default
    };

    private string GetStatusIconColor(DeviceStatus status) => status switch
    {
        DeviceStatus.Online => "#00ff88",
        DeviceStatus.Offline => "#78909c",
        DeviceStatus.Error => "#ef5350",
        DeviceStatus.Maintenance => "#ffa726",
        DeviceStatus.Provisioning => "#42a5f5",
        _ => "#90a4ae"
    };

    private string GetDeviceIcon(DeviceType type) => type switch
    {
        DeviceType.IpCamera => Icons.Material.Filled.Videocam,
        DeviceType.Tablet => Icons.Material.Filled.Tablet,
        DeviceType.MobileIos or DeviceType.MobileAndroid => Icons.Material.Filled.Smartphone,
        DeviceType.RaspberryPi => Icons.Material.Filled.DeveloperBoard,
        DeviceType.UsbWebcam => Icons.Material.Filled.Camera,
        DeviceType.DesktopBrowser => Icons.Material.Filled.Computer,
        _ => Icons.Material.Filled.Devices
    };
}

@* Register Device Dialog Component *@
@code {
    public class RegisterDeviceDialog : ComponentBase
    {
        [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
        [Inject] IVisionService VisionService { get; set; } = null!;
        [Inject] ISnackbar Snackbar { get; set; } = null!;

        private RegisterDeviceRequest _request = new();
        private bool _processing;

        private async Task Submit()
        {
            try
            {
                await VisionService.RegisterDeviceAsync(_request);
                MudDialog.Close(DialogResult.Ok(true));
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }

        private void Cancel() => MudDialog.Cancel();
    }
}
